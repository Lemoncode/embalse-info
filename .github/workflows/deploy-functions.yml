name: Deploy Azure Functions

on:
  push:
    branches: ["main"]

concurrency:
  group: functions-prod
  cancel-in-progress: true

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: "22"
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      # Build the internal db package first so TypeScript can resolve it (and its .d.ts files)
      - name: Build db package (types)
        run: npm run -w @embalse-info/db build

      - name: Build functions workspace
        run: npm run -w functions ci

      - name: Prepare deploy folder
        run: |
          rm -rf deploy
          mkdir -p deploy/packages

          cp functions/host.json deploy/host.json
          cp -R functions/dist deploy/dist
          cp -R packages/db deploy/packages/db

          node -e "
            const fs = require('fs');
            const pkg = JSON.parse(fs.readFileSync('functions/package.json','utf8'));
            pkg.name = 'functions-deploy';
            pkg.main = 'dist/index.js';
            pkg.dependencies = pkg.dependencies || {};
            pkg.dependencies['@embalse-info/db'] = 'file:./packages/db';
            fs.writeFileSync('deploy/package.json', JSON.stringify(pkg, null, 2));
          "

          cd deploy
          npm install --omit=dev --ignore-scripts

      - name: Deploy to Azure Functions
        uses: Azure/functions-action@v1
        with:
          app-name: fn-info-embalse-prod
          package: deploy
          publish-profile: ${{ secrets.AZURE_FUNCTIONAPP_PUBLISH_PROFILE }}
